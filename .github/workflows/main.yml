name: CI/CD - HealthMed

on:
  workflow_dispatch

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ’¾ Cache do NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: âš™ï¸ Setup do .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: ğŸ§ª Restore dependÃªncias
        run: dotnet restore ./backend/HealthMed.sln

      - name: ğŸ› ï¸ Build do projeto
        run: dotnet build ./backend/HealthMed.sln --configuration Debug --no-restore

      - name: âœ… Rodar testes unitÃ¡rios com cobertura
        working-directory: ./backend
        run: | 
         dotnet test HealthMed.Tests.Unit/HealthMed.Tests.Unit.csproj \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      - name: ğŸ“Š Publicar anÃ¡lise de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: cobertura-unit-tests
          path: backend/TestResults/**/coverage.cobertura.xml

      - name: ğŸ“ˆ Gerar resumo da cobertura
        working-directory: ./backend
        run: |
            dotnet tool install --global dotnet-reportgenerator-globaltool
            export PATH="$PATH:/home/runner/.dotnet/tools"
            REPORT_FILE=$(find TestResults -name 'coverage.cobertura.xml' | head -n 1)
            reportgenerator \
              -reports:"$REPORT_FILE" \
              -targetdir: TestResults/coverage-report \
              -reporttypes: TextSummary

      - name: ğŸ“ˆ Exibir cobertura no log da pipeline
        working-directory: ./backend
        run: |
            cat TestResults/coverage-report/Summary.txt || echo "Resumo nÃ£o encontrado."


      - name: âœ… CI finalizada com sucesso!
        run: |
          echo "======================================="
          echo "ğŸ‰ CI concluÃ­da com sucesso!"
          echo "âœ… Testes finalizados"
          echo "ğŸ“¦ Cobertura gerada"
          echo "======================================="
