name: CI/CD - HealthMed

on:
  workflow_dispatch

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout do repositório
        uses: actions/checkout@v4

      - name: 💾 Cache do NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: ⚙️ Setup do .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: 🧪 Restore dependências
        run: dotnet restore ./backend/HealthMed.sln

      - name: 🛠️ Build do projeto
        run: dotnet build ./backend/HealthMed.sln --configuration Debug --no-restore

      - name: ✅ Rodar testes unitários com cobertura
        working-directory: ./backend
        run: | 
         dotnet test HealthMed.Tests.Unit/HealthMed.Tests.Unit.csproj \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      - name: 📊 Publicar cobertura de testes
        uses: actions/upload-artifact@v4
        with:
          name: cobertura-unit-tests
          path: backend/TestResults/**/coverage.cobertura.xml

      - name: ✅ CI finalizada com sucesso!
        run: |
          echo "======================================="
          echo "🎉 CI concluída com sucesso!"
          echo "✅ Testes finalizados"
          echo "📦 Cobertura gerada"
          echo "======================================="
